<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Viteska – Otopark, Lastikçi & Oto Yıkama Harita</title>
  <style>
      * {
      -webkit-tap-highlight-color: transparent !important;
      -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
      outline: none !important;
      box-shadow: none !important;
    }
    button, .quick-box, .btn-menu, .menu-list a, .ad-row button {
      -webkit-tap-highlight-color: transparent !important;
      -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
      outline: none !important;
      box-shadow: none !important;
      user-select: none;
    }
    :root {
      --color-primary: #f27405;
      --color-blue: #3483fa;
      --color-green: #24c257;
      --color-bg: #fff;
      --font: 'Segoe UI', sans-serif;
    }
    html, body { margin: 0; padding: 0; font-family: var(--font); background: var(--color-bg); width: 100vw; height: 100vh; min-height: 100vh; overflow: hidden;}
    .container { width: 100vw; min-height: 100vh; display: flex; flex-direction: column; }
    .tabs { display: flex; width: 100vw; border-bottom: 2px solid #ececec; z-index: 20; position: relative; background:#fff;}
    .tab {
      flex: 1; text-align: center; padding: 15px 0;
      font-size: 1.12rem; font-weight: 700; letter-spacing: .02em;
      color: #b6b6b6; background: #fff;
      border-bottom: 4px solid #ececec;
      user-select: none; min-width: 1px; white-space: nowrap;
      cursor: pointer;
      transition: background .13s, color .13s, border .13s;
    }
    .tab.otopark.active { color:#fff; background: var(--color-green); border-bottom-color: var(--color-green);}
    .tab.lastikci.active { color:#fff; background: var(--color-primary); border-bottom-color: var(--color-primary);}
    .tab.yikamaci.active { color:#fff; background: var(--color-blue); border-bottom-color: var(--color-blue);}
    .tab:not(.active):hover { background:#f9f9f9;}
    .page { flex: 1 1 auto; width: 100vw; height: 100%; min-height: 0; position: relative; overflow: hidden; background: var(--color-bg);}
    #mapWrap { width: 100vw; height: calc(100vh - 51px); position: relative; margin: 0 auto;}
    #map { width: 100vw; height: 100%; border-radius: 0; box-shadow: none;}
    #mapLoading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff3eb; color: #c86e01; font-weight: 600; font-size: 1.13em; padding: 22px 28px; border-radius: 14px; z-index: 222; box-shadow: 0 3px 22px #ffc98a38;}

    /* Marker Modal (popup) */
    .modal-bg { display: none; position:fixed; left:0;top:0;width:100vw;height:100vh;z-index:9999; background: rgba(41,18,0,0.23); align-items: center; justify-content: center; transition: opacity .18s;}
    .modal-bg.active { display:flex; }
    .modal-inner {
      background: #fff7ee; border-radius: 13px; padding: 18px 14px 20px 14px; min-width: 310px; max-width: 95vw;
      box-shadow: 0 7px 36px #d2630040; position: relative; animation: pop .16s; margin: 20px; width: 96vw; max-width: 340px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    @keyframes pop {0%{transform:scale(.92);} 100%{transform:scale(1);}}
    .place-photo {width: 100%; max-height: 200px; border-radius: 11px; object-fit: cover; margin-bottom: 7px;}
    .modal-main-title {font-size: 1.18em; font-weight:700; color: var(--color-primary); margin-bottom: 6px;}
    .modal-main-title.yikamaci { color: var(--color-blue);}
    .modal-main-title.otopark { color: var(--color-green);}
    .modal-detail {color:#7b4716;font-size:.98em;margin-bottom:5px;}
    .modal-city {color:#b87904;font-size:.98em;margin-bottom:4px;}
    .stars {color:#e08e1e;font-size:1.11em;margin-bottom:7px;letter-spacing:.08em;}

    /* Modal altındaki tuş grubu */
    .modal-btn-group {
      display: flex;
      flex-direction: row;
      gap: 12px;
      justify-content: center;
      margin-top: 10px;
    }
    .modal-btn, .modal-close-btn {
      background: #f27405;
      color:#fff;
      border:none;
      padding: 8px 20px;
      border-radius: 9px;
      font-weight:600;
      font-size:1.07em;
      cursor:pointer;
      box-shadow:none;
      outline:none;
      transition: background .13s;
    }
    .modal-btn.yikamaci, .modal-close-btn.yikamaci {background: var(--color-blue);}
    .modal-btn.otopark, .modal-close-btn.otopark {background: var(--color-green);}
    .modal-btn:active, .modal-close-btn:active {opacity: 0.88;}
    .modal-close-btn { background: #111 !important; color: #fff !important;}

    /* Route info (alttaki kutu) */
    #routeInfoBox {
      position: fixed; left: 0; bottom: 0; width: 100vw; margin: 0 auto; z-index: 10001;
      display: none; pointer-events: none;
    }
    .route-info-inner {
      width: 100vw;
      min-width: 220px;
      max-width: 100vw;
      box-sizing: border-box;
      margin: 0 auto;
      background: #fff;
      color: #222;
      border-radius: 26px 26px 0 0;
      box-shadow: 0 -4px 26px #f2740540;
      font-weight: 500;
      font-size: 1.13em;
      padding: 32px 18px 22px 22px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 18px;
      pointer-events: auto;
      border-top: 5px solid var(--color-primary);
      transition: background .18s, box-shadow .18s;
    }
    .route-info-inner.yikamaci { border-top-color: var(--color-blue);}
    .route-info-inner.otopark { border-top-color: var(--color-green);}
    .route-title {
      font-weight:800;
      font-size:1.22em;
      margin-bottom:4px;
      color: var(--color-primary);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .route-info-inner.yikamaci .route-title {color:var(--color-blue);}
    .route-info-inner.otopark .route-title {color:var(--color-green);}
    .route-dist, .route-dur {
      font-size:1.09em;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .route-info-inner svg {vertical-align:middle;}
    .route-btn-group {
      display:flex;
      flex-direction:row;
      gap:16px;
      margin-top:10px;
      justify-content:center;
    }
    .route-gmaps-btn, .route-cancel-btn {
      background: #111 !important;
      color: #fff !important;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.07em;
      padding: 12px 22px;
      cursor: pointer;
      outline: none;
      box-shadow: none;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: background .13s;
    }
    .route-info-inner.yikamaci .route-gmaps-btn,
    .route-info-inner.yikamaci .route-cancel-btn {background: var(--color-blue);}
    .route-info-inner.otopark .route-gmaps-btn,
    .route-info-inner.otopark .route-cancel-btn {background: var(--color-green);}
    .route-cancel-btn {background: #111 !important; color: #fff !important;}
    @media (max-width: 1200px) { .container, #mapWrap, #map, .page {max-width: 100vw; width: 100vw;} }
    @media (max-width: 700px) {.route-info-inner {padding: 20px 4vw 16px 4vw; font-size:1.01em;}}
    /* Popup styles */
    .popup-info-bg {
      position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(41,18,0,0.22);
      display: flex; align-items: center; justify-content: center; z-index: 10010; transition: opacity .22s;
    }
    .popup-info { background: #fff7ee; border-radius: 16px; padding: 38px 32px 30px 32px; max-width: 350px; width: 95vw;
      box-shadow: 0 6px 50px #b8640018; text-align: center; position: relative; font-size:1.07em;}
    .popup-count {margin:12px auto 0 auto; color:#f27405; font-size:1.6em; font-weight:800; letter-spacing:.05em;}
    @media (max-width: 700px) {.popup-info {padding:30px 6vw 25px 6vw;}}
  </style>
</head>
<body>
<div class="container">
  <div class="tabs" id="tabs">
    <div class="tab otopark active" onclick="selectTab(0)">Otopark</div>
    <div class="tab lastikci" onclick="selectTab(1)">Lastikçi</div>
    <div class="tab yikamaci" onclick="selectTab(2)">Oto Yıkama</div>
  </div>
  <div class="page active" id="harita">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="mapLoading" class="loading" style="display:none;">Harita yükleniyor...</div>
    </div>
  </div>
</div>
<!-- Açılış Bilgilendirme Pop-up -->
<div class="popup-info-bg" id="infoPopup" style="display:none;">
  <div class="popup-info">
    <b><span id="popupRadius">5 KM</span> Çevreniz <span id="popupCategory">Komple</span> Haritada!</b>
    <div style="margin-top:10px; font-weight:500;">
      Konumunuza yakın Yerler Gösteriliyor <span id="popupCategory2"></span> Haritada otomatik gösterilecektir<br><br>
      <span style="color:#f27405;font-weight:700;">Harita yükleniyor...</span>
      <div class="popup-count"><span id="popupCountdown">5</span></div>
    </div>
  </div>
</div>
<div class="modal-bg" id="modalBg"></div>
<div id="routeInfoBox"><div class="route-info-inner" id="routeInfoInner"></div></div>

<script>
let map, markers = [], userMarker = null, userPos = null;
let directionsService, directionsRenderer, activeRouteType = null, activeRouteDest = null, routeInterval = null;
let modalOpen = false, activeRouteBounds = null;
let routeInfoData = {name: '', lat: null, lng: null, type: ''};
let activeTab = 0;
let isMapLoaded = false;

const BUSINESS_TYPES = [
  { keyword: "Otopark", label: "otopark", color: "#24c257", key: "otopark", iconClass: "otopark" },
  { keyword: "Lastikçi", label: "lastikçi", color: "#f27405", key: "lastikci", iconClass: "lastikci" },
  { keyword: "Oto Yıkama", label: "oto yıkama", color: "#3483fa", key: "yikamaci", iconClass: "yikamaci" }
];

// Her girişte popup göster
function showPopupAlways() {
    document.getElementById("infoPopup").style.display = "flex";
    popupCountdown = 5;
    document.getElementById('popupCountdown').innerText = popupCountdown;
    popupInterval = setInterval(()=>{
      popupCountdown--;
      document.getElementById('popupCountdown').innerText = popupCountdown;
      if (popupCountdown <= 0) {
        closeInfoPopup();
      }
    }, 1000);
}
function closeInfoPopup() {
    document.getElementById('infoPopup').style.display = "none";
    clearInterval(popupInterval);
}
let popupCountdown = 5, popupInterval = null;

// Marker Modal kapanma özelliği
document.addEventListener('click', function(e){
  const modalBg = document.getElementById('modalBg');
  if(modalOpen && e.target === modalBg) closeModal();
});

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

function searchPlacesForType(typeIndex) {
  clearMarkers();
  let type = BUSINESS_TYPES[typeIndex];
  fetchAllPages(type.keyword, type.color, type.key, (results) => {
    results.slice(0, 40).forEach(place => {
      addMarker(place, type.color, type.key);
    });
  });
}

function fetchAllPages(keyword, color, key, callback) {
  const allResults = [];
  function processPage(pageToken) {
    const request = {
      location: userPos,
      radius: 5000,
      keyword: keyword,
      ...(pageToken ? { pageToken } : {})
    };
    const service = new google.maps.places.PlacesService(map);
    service.nearbySearch(request, (results, status, pagination) => {
      if (status === google.maps.places.PlacesServiceStatus.OK && results) {
        allResults.push(...results);
        if (allResults.length >= 40) {
          callback(allResults.slice(0, 40));
        } else if (pagination && pagination.hasNextPage) {
          setTimeout(() => pagination.nextPage(), 1350);
        } else {
          callback(allResults);
        }
      } else {
        callback(allResults);
      }
    });
  }
  processPage();
}

function addMarker(place, color, key) {
  const marker = new google.maps.Marker({
    map,
    position: place.geometry.location,
    title: place.name,
    icon: {
      path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
      scale: 6,
      fillColor: color,
      fillOpacity: 1,
      strokeWeight: 1,
      strokeColor: "#fff"
    }
  });
  marker.addListener('click', ()=>showPlaceDetail(place.place_id, key));
  markers.push(marker);
}

function selectTab(idx) {
  if (activeTab === idx) return;
  activeTab = idx;
  document.querySelectorAll('.tab').forEach((t,i)=>{
    t.classList.toggle('active', i === activeTab);
  });
  // Popuptaki kategori adını güncelle (görünmeyecek ama kodda kalsın)
  let cat = BUSINESS_TYPES[activeTab].label;
  document.getElementById("popupCategory").innerText = cat + (cat==="oto yıkama" ? "lar" : "lar");
  document.getElementById("popupCategory2").innerText = cat;
  // Marker'ları kategoriye göre yükle
  if (isMapLoaded) searchPlacesForType(activeTab);
}

function initMap() {
  document.getElementById('mapLoading').style.display = '';
  navigator.geolocation.getCurrentPosition(pos => {
    userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    map = new google.maps.Map(document.getElementById('map'), {
      center: userPos, zoom: 13, mapTypeControl: false, streetViewControl: false, fullscreenControl: false
    });
    userMarker = new google.maps.Marker({
      map,
      position: userPos,
      icon: { path: google.maps.SymbolPath.CIRCLE, scale: 9, fillColor: "#18b501", fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2 },
      title: "Konumunuz"
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      polylineOptions: { strokeColor: "#f27405", strokeWeight: 5 },
      preserveViewport: true // Harita zoom/konumunu bozmasın!
    });
    directionsRenderer.setMap(map);
    searchPlacesForType(activeTab);
    document.getElementById('mapLoading').style.display = 'none';
    isMapLoaded = true;
  }, ()=>{
    alert('Konum alınamadı. Lütfen konum izni verin.');
    document.getElementById('mapLoading').style.display = 'none';
  });
}

// *** MODAL POPUP (Çarpı Yok, altta butonlar) ***
function showPlaceDetail(placeId, type) {
  const modalBg = document.getElementById('modalBg');
  modalOpen = true;
  modalBg.innerHTML = `<div class="modal-inner"><div style="padding:29px 0; text-align:center;">Yükleniyor...</div></div>`;
  modalBg.classList.add('active');
  const placesService = new google.maps.places.PlacesService(map);
  placesService.getDetails({
    placeId,
    fields: [
      'name','rating','photos','formatted_address','vicinity','formatted_phone_number',
      'website','opening_hours','geometry','types'
    ]
  }, (place, status)=>{
    if(status !== google.maps.places.PlacesServiceStatus.OK) return;
    let photoUrl = place.photos && place.photos[0] ? place.photos[0].getUrl({maxWidth:410,maxHeight:200}) : '';
    let stars = place.rating ? `<div class="stars">★ ${place.rating.toFixed(1)}</div>` : '';
    let address = place.formatted_address || place.vicinity || '';
    let phone = place.formatted_phone_number ? `<a href="tel:${place.formatted_phone_number.replace(/\s+/g,'')}" class="modal-btn${type==='yikamaci'?' yikamaci':''}${type==='otopark'?' otopark':''}">Ara</a>` : '';
    let gozatBtn = `<button class="modal-btn${type==='yikamaci'?' yikamaci':''}${type==='otopark'?' otopark':''}" style="margin-top:9px;" onclick="startRoutePreview('${place.name.replace(/'/g,"\\'")}', ${place.geometry.location.lat()}, ${place.geometry.location.lng()}, '${type}')">Göz At</button>`;
    // ALTTAKİ KAPAT TUŞU!
    let closeBtn = `<button class="modal-close-btn${type==='yikamaci'?' yikamaci':''}${type==='otopark'?' otopark':''}" style="margin-top:9px;" onclick="closeModal()">Kapat</button>`;
    modalBg.innerHTML = `
      <div class="modal-inner" onclick="event.stopPropagation()">
        ${photoUrl?`<img src="${photoUrl}" class="place-photo" alt="Görsel">`:""}
        <div class="modal-main-title${type==='yikamaci'?' yikamaci':''}${type==='otopark'?' otopark':''}">${place.name||''}</div>
        ${stars}
        <div class="modal-detail">${address}</div>
        ${place.formatted_phone_number?`<div class="modal-city"><b>Telefon:</b> ${place.formatted_phone_number}</div>`:""}
        <div class="modal-btn-group">${gozatBtn}${closeBtn}</div>
      </div>
    `;
  });
}
window.closeModal = function(){
  document.getElementById('modalBg').classList.remove('active');
  setTimeout(()=>{document.getElementById('modalBg').innerHTML='';modalOpen=false;}, 280);
}
window.startRoutePreview = function(name, lat, lng, type) {
  closeModal();
  routeInfoData = {name, lat, lng, type};
  activeRouteType = type;
  activeRouteDest = {lat, lng};
  updateRouteLive();
  if(routeInterval) clearInterval(routeInterval);
  routeInterval = setInterval(updateRouteLive, 3000);
}
function updateRouteLive(){
  if(!userPos || !activeRouteDest) return;
  const req = {
    origin: userPos,
    destination: activeRouteDest,
    travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(req, (result, status)=>{
    if(status === google.maps.DirectionsStatus.OK){
      directionsRenderer.setDirections(result);
      const leg = result.routes[0].legs[0];
      activeRouteBounds = result.routes[0].bounds;
      showRouteInfoBox(routeInfoData.name, leg.distance.text, leg.duration.text, activeRouteType, routeInfoData.lat, routeInfoData.lng);
    }
  });
}
function showRouteInfoBox(title, distance, duration, type, lat, lng){
  const routeBox = document.getElementById('routeInfoBox');
  const routeInner = document.getElementById('routeInfoInner');
  routeInner.className = "route-info-inner"+(type==='yikamaci'?' yikamaci':'')+(type==='otopark'?' otopark':'');
  routeInner.innerHTML = `
    <div class="route-title">
      <svg width="25" height="25" fill="none" viewBox="0 0 24 24"><circle fill="#f27405" cx="12" cy="12" r="12"/><path fill="#fff" d="M10.09 16.8c-2.36 0-3.51-1.45-3.51-2.9 0-1.23.94-2.15 2.35-2.38V10.6c0-1.14.93-2.07 2.08-2.07 1.15 0 2.08.93 2.08 2.07v.91c1.42.23 2.35 1.15 2.35 2.38 0 1.45-1.15 2.9-3.51 2.9Zm-1.6-2.9c0 .94.85 1.63 2.08 1.63s2.08-.7 2.08-1.63c0-.73-.72-1.34-2.08-1.34s-2.08.61-2.08 1.34Z"/></svg>
      ${title}
    </div>
    <div class="route-dist">
      <svg width="17" height="17" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M6.5 7a5.5 5.5 0 1 1 11 0c0 4.26-4.49 9.45-5.02 10.06a.75.75 0 0 1-1.14 0C10.99 16.45 6.5 11.26 6.5 7zm5.5-4a7.5 7.5 0 0 0-7.5 7.5c0 5.41 6.38 12.35 6.65 12.63a2.25 2.25 0 0 0 3.2 0c.27-.28 6.65-7.22 6.65-12.63A7.5 7.5 0 0 0 12 3z"/></svg>
      <b>Mesafe:</b> ${distance}
    </div>
    <div class="route-dur">
      <svg width="17" height="17" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3.25A8.75 8.75 0 1 0 20.75 12 8.76 8.76 0 0 0 12 3.25zm0 16A7.25 7.25 0 1 1 19.25 12 7.26 7.26 0 0 1 12 19.25z"/><path fill="currentColor" d="M12 7.75a.75.75 0 0 1 .75.75v2.94l2.23 1.29a.75.75 0 0 1-.76 1.3l-2.43-1.41a.75.75 0 0 1-.39-.65V8.5A.75.75 0 0 1 12 7.75z"/></svg>
      <b>Süre:</b> ${duration}
    </div>
    <div class="route-btn-group">
      <button class="route-gmaps-btn" onclick="goGoogleMaps(${lat},${lng})">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.013 10.013 0 0 0 12 2Zm0 15a5 5 0 1 1 5-5a5.006 5.006 0 0 1-5 5Zm1-5V7a1 1 0 0 0-2 0v6a1 1 0 0 0 .293.707l4 4a1 1 0 1 0 1.414-1.414Z"/></svg>
        Google Haritalar’da Yol Tarifi
      </button>
      <button class="route-cancel-btn" onclick="cancelRoute()">Kapat</button>
    </div>
  `;
  routeBox.style.display = "block";
}
window.cancelRoute = function(){
  directionsRenderer.set('directions', null);
  document.getElementById('routeInfoBox').style.display = "none";
  activeRouteType = null; activeRouteDest = null;
  if(routeInterval) clearInterval(routeInterval);
  routeInterval = null;
};
window.goGoogleMaps = function(lat, lng) {
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, "_blank");
}
window.initMap = initMap;

// Her girişte popup göster
window.onload = function() {
  showPopupAlways();
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
